name: Build and Test

# 1. Disparadores (Triggers)
# Se ejecuta en cada push a 'main' y en cada Pull Request que apunte a 'main'.
on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  # ----------------------------------------------------
  # TRABAJO 1: Compilar y Probar el Frontend (Vue.js)
  # ----------------------------------------------------
  build-and-test-frontend:
    name: Build & Test Frontend
    runs-on: ubuntu-latest

    # Establece el directorio de trabajo para todos los comandos
    defaults:
      run:
        working-directory: ./client

    steps:
      - name: 1. Checkout Code
        uses: actions/checkout@v4

      - name: 2. Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20' 
          cache: 'npm'
          cache-dependency-path: client/package-lock.json

      - name: 3. Install Dependencies
        run: npm install

      - name: 4. Run Linter 
        run: npm run lint

      - name: 5. Build Project
        run: npm run build

   #   - name: 6. Run Unit Tests
    #    run: npm run test:unit -- --run # Pasa el flag --run a vitest

  # ----------------------------------------------------
  # TRABAJO 2: Compilar y Probar el Backend (.NET)
  # ----------------------------------------------------
  build-and-test-backend:
    name: Build & Test Backend
    runs-on: ubuntu-latest

    # 2. Inicia un servicio de SQL Edge
    # Esto inicia un contenedor de Docker junto a tu trabajo
    services:
      sql-edge:
        image: mcr.microsoft.com/azure-sql-edge:latest
        ports:
          - 1433:1433
        env:
          ACCEPT_EULA: 'Y'
          SA_PASSWORD: ${{ secrets.DB_TEST_PASSWORD }}
        # Esta opción espera hasta que la BD esté lista para aceptar conexiones
        options: >-
          --health-cmd "/opt/mssql-tools18/bin/sqlcmd -S localhost -U sa -P '${{ secrets.DB_TEST_PASSWORD }}' -Q 'SELECT 1' || exit 1"
          --health-interval 10s
          --health-retries 10
          --health-start-period 30s
          --health-timeout 5s

    steps:
      - name: 1. Checkout Code
        uses: actions/checkout@v4

      - name: 2. Setup .NET 9
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '9.0.x' # Usa el SDK de .NET 9

      - name: 3. Restore Dependencies
        run: dotnet restore AccountPanel/AccountPanel.sln

      - name: 4. Build Solution
        run: dotnet build AccountPanel/AccountPanel.sln --no-restore

      - name: 5. Run Tests (Unit & Integration)
        run: dotnet test AccountPanel/AccountPanel.sln --no-build --verbosity normal
        env:
          # --- ¡IMPORTANTE! Provee los secretos que tu TestApiFactory necesita ---
          
          # 1. Secreto para la contraseña del servicio de BD
          TestDb:Password: ${{ secrets.DB_TEST_PASSWORD }}
          
          # 2. Secreto para la cadena de conexión de prueba (apunta al servicio de Docker)
          ConnectionStrings__TestConnection: "Server=localhost,1433;Database=master;User Id=sa;Password=${{ secrets.DB_TEST_PASSWORD }};TrustServerCertificate=True;"
          
          # 3. Otros secretos que tu app lee de IConfiguration (aunque estén mockeados)
          # Es buena práctica proveerlos para que la app se construya.
          MailtrapSettings__Username: "test"
          MailtrapSettings__Password: "test"
          Authentication__Google__ClientId: "test"
          Authentication__Google__ClientSecret: "test"
          AppSettings__FrontendBaseUrl: "http://localhost:5173"
          Jwt__Key: ${{ secrets.JWT_KEY }}
          AutoMapper__Key: ${{ secrets.AUTOMAPPER_KEY }}
          AdminUser__Email: "admin@test.com"
          AdminUser__Password: "AdminPassword123!"