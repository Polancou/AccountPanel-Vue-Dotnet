name: Build and Test

# 1. Disparadores (Triggers)
# Se ejecuta en cada push a 'main' y en cada Pull Request que apunte a 'main'.
on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  # ----------------------------------------------------
  # TRABAJO 1: Compilar y Probar el Frontend (Vue.js)
  # ----------------------------------------------------
  build-and-test-frontend:
    name: Build & Test Frontend
    runs-on: ubuntu-latest

    defaults:
      run:
        working-directory: ./client

    steps:
      - name: 1. Checkout Code
        uses: actions/checkout@v4

      - name: 2. Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: client/package-lock.json

      - name: 3. Install Dependencies
        run: npm install

      - name: 4. Run Linter
        run: npm run lint

      - name: 5. Build Project
        run: npm run build

  # ----------------------------------------------------
  # TRABAJO 2: Compilar y Probar el Backend (.NET)
  # ----------------------------------------------------
  build-and-test-backend:
    name: Build & Test Backend
    runs-on: ubuntu-latest

    services:
      sql-edge:
        image: mcr.microsoft.com/azure-sql-edge:latest
        ports:
          - 1433:1433
        env:
          ACCEPT_EULA: 'Y'
          SA_PASSWORD: "YourStrong!Passw0rd"
        options: >-
          --health-cmd "/opt/mssql-tools18/bin/sqlcmd -S localhost -U sa -P 'YourStrong!Passw0rd' -Q 'SELECT 1' || exit 1"
          --health-interval 10s
          --health-retries 10
          --health-start-period 30s
          --health-timeout 5s

    steps:
      - name: 1. Checkout Code
        uses: actions/checkout@v4

      - name: 2. Setup .NET 9
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '9.0.x'

      - name: 3. Restore Dependencies
        run: dotnet restore AccountPanel/AccountPanel.sln

      - name: 4. Build Solution
        run: dotnet build AccountPanel/AccountPanel.sln --no-restore

      - name: 5. Run Tests (Unit & Integration)
        run: dotnet test AccountPanel/AccountPanel.sln --no-build --verbosity normal
        env:
          ConnectionStrings__TestConnection: "Server=localhost,1433;Database=master;User Id=sa;Password=YourStrong!Passw0rd;TrustServerCertificate=True;"

          MailtrapSettings__Username: "test"
          MailtrapSettings__Password: "test"
          Authentication__Google__ClientId: "test"
          Authentication__Google__ClientSecret: "test"
          AppSettings__FrontendBaseUrl: "http://localhost:5173"
          Jwt__Key: ${{ secrets.JWT_KEY }}
          AutoMapper__Key: ${{ secrets.AUTOMAPPER_KEY }}
          AdminUser__Email: "admin@test.com"
          AdminUser__Password: "AdminPassword123!"